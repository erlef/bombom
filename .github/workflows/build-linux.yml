name: Build bombom.bin - (linux)

on:
  workflow_call:
    inputs:
      otp_version:
        type: string
        description: OTP version to use
        required: true
        default: "28.1.1"
      rebar_version:
        type: string
        description: Rebar version to use
        required: true
        default: "3.26.0"
      attest:
        type: boolean
        description: Whether to attest the build provenance
        required: false
        default: false

permissions:
  contents: read
  id-token: write
  attestations: write

env:
  OTP_VERSION: "28.1.1"
  REBAR_VERSION: "3.26.0"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential pkg-config zlib1g-dev

      - name: Setup BEAM
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ inputs.otp_version || env.OTP_VERSION }}
          rebar3-version: ${{ inputs.rebar_version || env.REBAR_VERSION }}

      - name: Build binaries using cassone
        run: |
          rebar3 cassone

      - name: Generate checksums
        run: |
          sha256sum ${{github.workspace}}/bombom-linux-arm64.bin > ${{github.workspace}}/bombom-linux-arm64.bin.sha256
          sha256sum ${{github.workspace}}/bombom-linux-amd64.bin > ${{github.workspace}}/bombom-linux-amd64.bin.sha256

      - name: Attest build provenance (arm64)
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        id: attest-provenance-arm64
        if: ${{ inputs.attest }}
        with:
          subject-path: ${{ github.workspace }}/bombom-linux-arm64.bin

      - name: Attest build provenance (amd64)
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        id: attest-provenance-amd64
        if: ${{ inputs.attest }}
        with:
          subject-path: ${{ github.workspace }}/bombom-linux-amd64.bin

      - name: Export provenance bundle
        if: ${{ inputs.attest }}
        env:
          ATT_BUNDLE_ARM64: ${{ steps.attest-provenance-arm64.outputs.bundle-path }}
          ATT_BUNDLE_AMD64: ${{ steps.attest-provenance-amd64.outputs.bundle-path }}
        run: |
          set -euo pipefail
          cp "${{ env.ATT_BUNDLE_ARM64 }}" "${{ github.workspace }}/bombom-linux-arm64.bin.sigstore"
          cp "${{ env.ATT_BUNDLE_AMD64 }}" "${{ github.workspace }}/bombom-linux-amd64.bin.sigstore"


      - name: Upload arm64 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bombom-linux-arm64
          path: |
            ${{github.workspace}}/bombom-linux-arm64.bin
            ${{github.workspace}}/bombom-linux-arm64.bin.sha256
            ${{github.workspace}}/bombom-linux-arm64.bin.sigstore

      - name: Upload amd64 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bombom-linux-amd64
          path: |
            ${{github.workspace}}/bombom-linux-amd64.bin
            ${{github.workspace}}/bombom-linux-amd64.bin.sha256
            ${{github.workspace}}/bombom-linux-amd64.bin.sigstore
